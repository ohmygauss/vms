require 'rails_helper'

describe 'Vulnerability Feature', type: :feature do
  before(:each) do
    @product = create(:product, name: 'Test 1')

    http_login 
    visit '/'
    click_on 'Details'
    click_on 'Add vulnerability'
    fill_in 'Issue', with: 'an issue'
    fill_in 'Severity', with: 'high'
    fill_in 'Remediation', with: 'a fix'
    click_on 'Create Vulnerability'
  end

  describe 'Adding vulnerabilities' do
    it 'allows vulnerabilities to be added via a form' do
      expect(page).to have_content 'Issue: an issue'
      expect(page).to have_content 'Severity: high'
      expect(page).to have_content 'Remediation: a fix'
    end
  end

  describe 'Closing vulnerabilities' do
    it 'allows a vulnerability to be marked as resolved' do
      click_on 'Resolve'

      expect(page).to have_content 'Vulnerability was successfully resolved'
      expect(page).to have_content " âœ” #{@product.vulnerabilities.first.resolved_time}" 
    end
  end 

  describe 'Deleting vulnerabilities' do
    it 'allows vulnerabilities to be deleted if created in error or no longer relevant' do
      click_on 'Destroy'

      expect(page).to have_content 'Vulnerability was successfully destroyed'
      expect(page).not_to have_content 'an issue'
    end
  end
end